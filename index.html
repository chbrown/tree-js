<!DOCTYPE html>
<meta charset="utf-8">
<style>
body { margin: 0; padding: 0; }
canvas {
  position: absolute;
  right: 0;
  border-left: 1px dotted #ccc;
  border-bottom: 1px dotted #ccc;
  font-family: "Times New Roman";
  z-index: 100;
}
#tex {
  border: none;
  border-right: 1px solid #777;
  position: relative;
  font: 10px Monaco, "Courier New", san-serif;
  width: 60%;
  z-index: 1;
  resize: none;
}
#examples {
  position: fixed;
  left: 0;
  bottom: 0;
  margin: 0;
  padding: 10px;
  background-color: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(127, 127, 127, 0.5);
  z-index: 100000;
}
#examples li {
  font: 11px Arial;
  list-style: none;
  padding: 0;
}
</style>

<script src="lib/jquery.js"></script>
<script src="tree.js"></script>

<div id="container">
  <textarea id="tex"></textarea>
  <canvas id="tree"></canvas>
  <!-- <div id="content"></div> -->
  <ul id="examples">
    <li>
      <a href="#">He looked down the canyon.</a>
      <script type="text/latex">
      \Tree [.S
        {NP\\ He}
        [.VP {V\\ looked} [.PP {P\\down} {NP\\ the canyon} ] ]
      ]
      </script>
    <li>
      <a href="#" class="initial">The mad old scientist ran from the lighthouse to his factory.</a>
      <script type="text/latex">
      \Tree [.CP [.TP
        [.NP {D\\The} [.AdjP {Adj\\mad} ] [.AdjP {Adj\\old} ] {N\\scientist} ]
        [.VP {V \\ ran}
          [.PP {P\\from} [.NP {D\\the} {N\\lighthouse} ] ]
          [.PP {P\\to} [.NP {D\\his} {N\\factory} ] ]
        ]
      ] ]
      </script>
    <li>
      <a href="#">A young cricketer from Wales with a bat and an attitude has finally claimed the ashes.</a>
      <script type="text/latex">
      \Tree [.CP
        [.TP
          [.NP
            {D\\A}
            [.AdjP {Adj\\young} ]
            {N\\cricketer}
            [.PP {P\\from} [.NP {N\\Wales} ] ]
            [.PP
              {P\\with}
              [.NP
                [.NP {D\\a} {N\\bat} ]
                {Conj\\and}
                [.NP {D\\an} {N\\attitude} ]
              ]
            ]
          ]
          [.{T\1}
            {T\\has}
            [.VP
              [.AdvP {Adv\\finally} ]
              {V\\claimed}
              [.NP {D\\the} {N\\ashes} ]
            ]
          ]
        ]
      ]
      </script>
    <li>
      <a href="#">Abelard has written a volume of poems in Latin for Heloise.</a>
      <script type="text/latex">
      \Tree [.CP [.TP
        [.NP {} [.N\1 {N\\Abelard} {} ] ]
        {T\\has}
        [.VP [.V\1
          [.V\1
            {V\\written}
            [.NP
              {D\\a}
              [.N\1
                [.N\1
                  {N\\volume}
                  [.PP {} [.P\1
                    {P\\of}
                    [.NP {} [.N\1 {N\\poems} {} ] ]
                  ] ]
                ]
                [.PP {} [.P\1
                  {P\\in}
                  [.NP {} [.N\1 {N\\Latin} {} ] ]
                ] ]
              ]
            ]
          ]
          [.PP {} [.P\1
            {P\\for}
            [.NP {} [.N\1 {N\\Heloise} {} ] ]
          ] ]
        ] ]
      ] ]
      </script>
    <li>
      <a href="#">I often wonder if John has a good grasp of the idea that Sandy stole our entire collection from the museum.</a>
      <script type="text/latex">
      \Tree [.CP [.TP
        [.NP {} [.N\1 {N\\I} { } ] ]
        [.VP
          [.V\1
            [.AdvP [.Adv\1 {Adv\\often} {} ] ]
            [.V\1
              {V\\wonder}
              [.CP
                {C\\if}
                [.TP
                  [.NP {}
                    [.N\1 {N\\John} {} ]
                  ]
                  [.VP
                    [.V\1
                      {V\\has}
                      [.NP
                        {D\\a}
                        [.N\1
                          [.AdjP [.Adj\1 {Adj\\good} {} ] ]
                          [.N\1
                            {N\\grasp}
                            [.PP {} [.P\1
                              {P\\of}
                              [.NP
                                {D\\the}
                                [.N\1
                                  {N\\idea}
                                  [.CP
                                    {C\\that}
                                    [.TP
                                      [.NP {} [.N\1 {N\\Sandy} {} ] ]
                                      [.VP [.V\1
                                        [.V\1
                                          {V\\stole}
                                          [.NP
                                            {D\\our}
                                            [.N\1
                                              [.AdjP [.Adj\1 {Adj\\entire} {} ] ]
                                              [.N\1
                                                {N\\collection}
                                                {}
                                              ]
                                            ]
                                          ]
                                        ]
                                        [.PP {} [.P\1
                                          {P\\from}
                                          [.NP
                                            {D\\the}
                                            [.N\1 {N\\museum} {} ]
                                          ]
                                        ] ]
                                      ] ]
                                    ]
                                  ]
                                ]
                              ]
                            ] ]
                          ]
                        ]
                      ]
                    ]
                  ]
                ]
              ]
            ]
          ]
        ]
      ] ]
      </script>
  </ul>
</div>

<script>
// $(function() { });
var $canvas = $('#tree'),
  canvas = $canvas[0],
  ctx = canvas.getContext("2d");

function undent(string) {
  var indent = 100, lines = string.split(/\n/g);
  lines.forEach(function(line) {
    var whitespace = line.match(/^(\s+)\S/);
    if (whitespace)
      indent = Math.min(whitespace[1].length, indent);
  });
  return lines.map(function(line) {
    return line.slice(indent);
  }).join('\n');
}

var root = null, height = 50;
function draw() {
  if (root) {
    canvas.width = canvas.width;

    ctx.save();
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.translate(10, 10);
    ctx.strokeStyle = '#222';
    ctx.fillStyle = '#222';

    root.draw(ctx, height, 0, 0);
    ctx.restore();
  }
}

$('#tex').on('focus', function() {
  $(this).css('z-index', 10000);
}).on('blur', function() {
  $(this).css('z-index', 1);
});

$('#tex').on('change keyup', function() {
  var tex = $(this).val();
  root = new TexParser(tex).parse();
  root.layout(ctx);
  root.recenter();

  canvas.width = root.box_width + 20;
  canvas.height = (root.level() * height) + 20;
  $(this).height(Math.max($(window).height() - 10, canvas.height));
  // webkitRequestAnimationFrame(draw);
  draw();
});

$('ul a').on('click', function(ev) {
  ev.preventDefault();
  var tex = $(this).parent().children('script').text();
  $('textarea').val(undent(tex)).change();
}).filter('.initial').click();
</script>
